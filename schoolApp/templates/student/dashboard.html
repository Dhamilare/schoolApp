{# core_app/templates/core_app/student_dashboard.html #}
{% extends 'base.html' %} {# CORRECTED: Changed to core_app/base.html #}
{% load static %}
{% load mathfilters %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container mx-auto p-4 md:p-6 lg:p-8 font-inter"> {# Added font-inter #}
    <h1 class="text-4xl font-extrabold text-center bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600 mb-8 animate-fade-in-down"> {# Updated gradient #}
        <i class="fas fa-user-graduate mr-3 text-indigo-500"></i>{{ page_title }}
    </h1>

    <div class="bg-white p-8 rounded-xl shadow-2xl w-full border border-gray-200 animate-fade-in mb-8">
        <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center"><i class="fas fa-info-circle mr-3 text-purple-500"></i>My Profile Summary</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-lg">
            <div>
                <p><strong class="text-gray-700">Name:</strong> {{ student_profile.get_full_name }}</p>
                <p><strong class="text-gray-700">Student ID:</strong> {{ student_profile.pk|default:"N/A" }}</p> {# Using pk for student ID as it's the primary key #}
                <p><strong class="text-gray-700">Class:</strong> {{ student_profile.current_class.name|default:"Unassigned" }}</p>
            </div>
            <div>
                <p><strong class="text-gray-700">Date of Birth:</strong> {{ student_profile.date_of_birth|date:"F d, Y"|default:"N/A" }}</p> {# Added default #}
                <p><strong class="text-gray-700">Gender:</strong> {{ student_profile.get_gender_display|default:"N/A" }}</p> {# Added default #}
                <p><strong class="text-gray-700">Parent:</strong> {% if student_profile.parent %}{{ student_profile.parent.get_full_name|default:student_profile.parent.username }}{% else %}Not Assigned{% endif %}</p>
            </div>
        </div>
        <div class="mt-6 text-center">
            <p class="text-xl font-bold text-indigo-600">
                Current Term Average:
                {% if overall_average is not None %}
                    <span class="text-4xl font-extrabold text-purple-600">{{ overall_average|floatformat:0 }}%</span>
                {% else %}
                    <span class="text-xl text-gray-500">N/A (No scores yet for {{ current_term.name|default:"current term" }})</span>
                {% endif %}
            </p>
        </div>
    </div>

    {# Assignments Section #}
    <div class="bg-white p-8 rounded-xl shadow-2xl w-full border border-gray-200 animate-fade-in mb-8">
        <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center"><i class="fas fa-clipboard-list mr-3 text-purple-500"></i>My Assignments</h2>
        {% if assignments_data %}
        <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-md">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-100">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                            Assignment
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                            Subject
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                            Due Date
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                            Status
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                            Score
                        </th>
                        <th scope="col" class="px-6 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">
                            Actions
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-100">
                    {% for data in assignments_data %}
                    <tr class="hover:bg-blue-50 transition-colors duration-200 ease-in-out">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            {{ data.assignment.title }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                            {{ data.assignment.subject.name }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                            {{ data.assignment.due_date|date:"F d, Y" }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            {% if data.is_submitted %}
                                {% if data.is_graded %}
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Graded</span>
                                {% else %}
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Submitted (Pending Grade)</span>
                                {% endif %}
                            {% elif data.is_overdue %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Overdue</span>
                            {% else %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">Assigned</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                            {% if data.is_graded %}
                                <span class="font-semibold">{{ data.score.score_achieved|floatformat:0 }}/{{ data.assignment.max_score|floatformat:0 }}</span>
                            {% else %}
                                <span class="text-gray-500">Not Graded</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                            <a href="{% url 'submit_assignment' data.assignment.id %}"
                               class="{% if data.is_graded %}text-gray-500 cursor-not-allowed{% else %}text-indigo-600 hover:text-indigo-900{% endif %}
                               transition duration-200 inline-flex items-center group
                               {% if data.is_graded %}pointer-events-none{% endif %}"> {# Disable clicks if graded #}
                                {% if data.is_submitted %}
                                    {% if data.is_graded %}
                                        <i class="fas fa-eye mr-1"></i>View Submission
                                    {% else %}
                                        <i class="fas fa-edit mr-1"></i>Edit Submission
                                    {% endif %}
                                {% else %}
                                    <i class="fas fa-paper-plane mr-1"></i>Submit
                                {% endif %}
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-6 rounded-lg shadow-md mt-4 animate-fade-in" role="alert">
            <p class="font-bold text-xl mb-2"><i class="fas fa-info-circle mr-2"></i>No assignments found for your class this term.</p>
            <p class="text-lg">Check back later or contact your teacher for more information.</p>
        </div>
        {% endif %}
    </div>

    {# Recent Attendance Section #}
    <div class="bg-white p-8 rounded-xl shadow-2xl w-full border border-gray-200 animate-fade-in mb-8">
        <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center"><i class="fas fa-calendar-check mr-3 text-purple-500"></i>Recent Attendance</h2>
        {% if recent_attendance %}
        <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-md">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-100">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                            Date
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                            Status
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                            Class
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                            Recorded By
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-100">
                    {% for record in recent_attendance %}
                    <tr class="hover:bg-blue-50 transition-colors duration-200 ease-in-out">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            {{ record.date|date:"F d, Y" }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            {% if record.status == 'P' %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Present</span>
                            {% elif record.status == 'A' %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Absent</span>
                            {% elif record.status == 'L' %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Late</span>
                            {% else %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">Unknown</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                            {{ record.class_name_display }} {# FIXED: Using the new property #}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                            {{ record.recorded_by.get_full_name|default:record.recorded_by.username }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-6 rounded-lg shadow-md mt-4 animate-fade-in" role="alert">
            <p class="font-bold text-xl mb-2"><i class="fas fa-info-circle mr-2"></i>No recent attendance records found.</p>
            <p class="text-lg">Your attendance records will appear here as they are marked.</p>
        </div>
        {% endif %}
    </div>

</div>
{% endblock %}

{% block extra_js %}
{% endblock %}
